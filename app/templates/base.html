<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/sketchy/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3">
    <style>
    body {
      background-color: #eeeeee;
    }

    #editor-container {
      height: 25rem;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #editor {
      height: 25rem;
      flex: 1;
      overflow-y: auto;
      width: 100%;
    }

    {% block style %}
    {% endblock style%}
    </style>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.snow.css"
          rel="stylesheet" />
  </head>
  <body>
    {% include "header.html" %}
    {% block main %}
    {% endblock main %}
    {% include "footer.html" %}
    <!-- Modal -->
    <div class="modal fade"
         id="postModal"
         tabindex="-1"
         aria-labelledby="postModalLabel"
         aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="postModalLabel">Share your travel journal...</h1>
            <button type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="input-group mb-3">
              <input type="text"
                     class="form-control"
                     placeholder="Title"
                     aria-label="title"
                     aria-describedby="title">
            </div>
            <div id="editor"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary">Submit</button>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.js"></script>
    <!-- Initialize Quill editor -->
    <script>
    const toolbarOptions = [
      ['bold', 'italic', 'underline', 'strike'],
      ['blockquote', 'code-block'],
      ['link', 'image'],
      [{ 'list': 'ordered' }, { 'list': 'bullet' }, { 'list': 'check' }],
      [{ 'header': [1, 2, 3, 4, 5, 6, false] }],

      [{ 'color': [] }, { 'background': [] }],
      [{ 'align': [] }],
    ];

    const imgHandler = (value) => {
      console.log(value)
    }

    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: {
        toolbar: toolbarOptions
      }
    });

    function selectLocalImage() {
      const input = document.createElement('input');
      input.setAttribute('type', 'file');
      input.setAttribute('accept', 'image/png, image/gif, image/jpeg')
      input.click();

      input.onchange = () => {
        const file = input.files[0];
        if (/^image\//.test(file.type)) {
          upload(file);
        } else {
          console.warn('You could only upload images.');
        }
      };
    }

    function upload(file) {
      const fd = new FormData();
      fd.append('image', file);

      const xhr = new XMLHttpRequest();
      xhr.open('POST', 'http://localhost:3000/upload/image', true);
      xhr.onload = () => {
        if (xhr.status === 200) {
          const url = JSON.parse(xhr.responseText).data;
          addImageToEditor(url);
        }
      };
      xhr.send(fd);
    }

    function addImageToEditor(url) {
      const range = editor.getSelection();
      editor.insertEmbed(range.index, 'image', `http://localhost:9000${url}`);
    }
    quill.getModule('toolbar').addHandler('image', () => {
      selectLocalImage();
    });


    </script>
  </body>
</html>
